# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: strava-merge
workflows:
  up:
    steps:
      - azd: provision
      - azd: deploy --all
services:
  web:
    project: ./src/web
    dist: dist
    language: js
    host: staticwebapp
    hooks:
      prepackage:
        windows:
          shell: pwsh
          run: |
            echo "VITE_APPLICATIONINSIGHTS_CONNECTION_STRING=""$env:APPLICATIONINSIGHTS_CONNECTION_STRING""" > .env.local
            (Get-Content staticwebapp.config.json) -replace '__AAD_TENANT_ID__', $env:AZURE_TENANT_ID | Set-Content staticwebapp.config.json
        posix:
          shell: sh
          run: |
            echo VITE_APPLICATIONINSIGHTS_CONNECTION_STRING=\"$APPLICATIONINSIGHTS_CONNECTION_STRING\" > .env.local
            sed -i.bak "s/__AAD_TENANT_ID__/$AZURE_TENANT_ID/g" staticwebapp.config.json && rm -f staticwebapp.config.json.bak
      postdeploy:
        windows:
          shell: pwsh
          run: |
            rm .env.local
            git checkout staticwebapp.config.json 2>$null
        posix:
          shell: sh
          run: |
            rm .env.local
            git checkout staticwebapp.config.json 2>/dev/null || true
  api:
    project: ./src/api
    language: py
    host: containerapp
